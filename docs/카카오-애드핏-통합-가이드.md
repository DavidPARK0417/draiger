# 카카오 애드핏 (Kakao AdFit) 통합 가이드

> **작성일**: 2026-01-21  
> **작성자**: 박용범 (decidepyb@gmail.com)  
> **최종 업데이트**: 2026-01-21

---

## 📋 목차

1. [개요](#-개요)
2. [주요 개선사항 (2026-01-21)](#-주요-개선사항-2026-01-21)
3. [카카오 애드핏 통합 방법](#-카카오-애드핏-통합-방법)
4. [공식 문서 준수 사항](#-공식-문서-준수-사항)
5. [트러블슈팅](#-트러블슈팅)
6. [업데이트 이력](#-업데이트-이력)

---

## 🎯 개요

이 문서는 Next.js 프로젝트에 카카오 애드핏 광고를 통합하는 방법을 설명합니다.

**공식 문서**: [AdFit Web SDK GitHub](https://github.com/adfit/adfit-web-sdk)

---

## ⚡ 주요 개선사항 (2026-01-21)

### 문제점 분석

기존 구현에서 다음과 같은 문제가 발견되었습니다:

1. **광고 로딩 실패**: 
   - 콘솔 로그: `[AdFit] 스크립트 대기 중, 재시도 1/10` → `최대 재시도 횟수(10) 초과, 광고 초기화 중단`
   - 원인: `layout.tsx`에서 스크립트를 `strategy="lazyOnload"`로 설정하여 너무 늦게 로드됨

2. **과도한 복잡성**:
   - AdFit 컴포넌트에 불필요한 재시도 로직, 수동 스캔 시도 등 복잡한 로직 포함
   - 공식 문서: AdFit 스크립트가 자동으로 `<ins>` 태그를 스캔하므로 단순하게 구현해야 함

3. **프로덕션 환경의 디버그 로그**:
   - 개발 환경뿐만 아니라 프로덕션 환경에서도 콘솔에 디버그 로그가 출력됨
   - `.cursorrules`의 규칙 위반

4. **페이지 렌더링 문제**:
   - `SmoothScroll` 컴포넌트로 인한 Hydration Mismatch 발생
   - `MarkdownImage` 컴포넌트의 복잡한 로직으로 인한 렌더링 중단
   - 본문 콘텐츠가 표시되지 않아 광고도 함께 숨겨짐

### 개선 내용

#### 1. 스크립트 로딩 전략 개선

**변경 전 (src/app/layout.tsx)**:
```typescript
<Script
  src="https://t1.daumcdn.net/kas/static/ba.min.js"
  strategy="lazyOnload"  // ❌ 너무 늦게 로드됨
  type="text/javascript"
  charSet="utf-8"
/>
```

**변경 후**:
```typescript
<Script
  src="https://t1.daumcdn.net/kas/static/ba.min.js"
  strategy="afterInteractive"  // ✅ 페이지 인터랙티브 후 즉시 로드
  type="text/javascript"
  charSet="utf-8"
/>
```

**효과**: 광고 스크립트가 페이지 로드 직후 빠르게 로드되어 광고가 즉시 표시됩니다.

#### 2. AdFit 컴포넌트 대폭 단순화

**변경 사항**:
- **코드 라인 수**: 약 360줄 → 약 110줄 (70% 감소)
- **복잡한 로직 제거**:
  - ❌ 스크립트 로드 확인 및 재시도 로직
  - ❌ 수동 `adfit.init()` 호출
  - ❌ `<ins>` 태그 재추가
  - ❌ 과도한 디버그 로그
- **남은 핵심 로직**:
  - ✅ `<ins>` 태그 올바르게 렌더링
  - ✅ NO-AD 콜백 함수 지원
  - ✅ 타입 안정성 유지

**공식 문서 권장사항**:
> AdFit 스크립트는 페이지 로드 시 자동으로 `<ins class="kakao_ad_area">` 태그를 스캔하여 광고를 표시합니다. 별도의 초기화 코드는 필요하지 않습니다.

#### 3. 프로덕션 환경 디버그 로그 제거

**변경 전**:
```typescript
// 모든 환경에서 로그 출력
console.log('[AdFit] 스크립트 대기 중, 재시도', retry, '/', maxRetries);
```

**변경 후**:
```typescript
// 로그 제거 (필요한 경우에만 조용히 처리)
```

**효과**: 프로덕션 환경의 콘솔이 깨끗해지고, `.cursorrules` 규칙을 준수합니다.

#### 4. 페이지 렌더링 개선

**변경 사항**:
1. **`SmoothScroll` 컴포넌트 제거**:
   - Hydration Mismatch 문제 해결
   - 서버/클라이언트 불일치 제거

2. **`MarkdownImage` 컴포넌트 단순화**:
   - 복잡한 상태 관리 로직을 단순 img 태그로 대체
   - `return null` 대신 항상 무언가를 렌더링하도록 개선
   - useEffect 의존성 배열 오류 수정

3. **ReactMarkdown img 컴포넌트 직접 처리**:
   - 외부 이미지는 프록시를 통해 로드
   - 단순하고 안정적인 렌더링

**변경 전**:
```typescript
import MarkdownImage from "@/components/MarkdownImage";

img: ({ src, alt, ...props }) => {
  const srcString = typeof src === 'string' ? src : ...;
  return <MarkdownImage src={srcString} alt={alt} {...props} />;
}
```

**변경 후**:
```typescript
img: ({ src, alt, ...props }) => {
  if (!src) return null;
  
  const isExternalImage = src.startsWith('http://') || src.startsWith('https://');
  const proxySrc = isExternalImage ? `/api/proxy-image?url=${encodeURIComponent(src)}` : src;
  
  return (
    <div className="my-8">
      <img src={proxySrc} alt={alt || "이미지"} loading="lazy" {...props} />
    </div>
  );
}
```

**효과**: 본문과 광고가 모두 정상적으로 표시됩니다.

---

## 🔧 카카오 애드핏 통합 방법

### 1. 애드핏 계정 설정

1. [카카오 애드핏](https://adfit.kakao.com/) 사이트 방문
2. 계정 생성 및 로그인
3. **광고 단위 생성**:
   - 플랫폼: **Web**
   - 광고 유형: 배너, 네이티브 등 선택
   - 광고 크기: 300x250, 320x100 등 선택
4. 광고 단위 ID(`DAN-XXXXXXXXXXXX`) 복사

### 2. Next.js 프로젝트 설정

#### 1) layout.tsx에 스크립트 추가

`src/app/layout.tsx` 파일의 `</body>` 태그 바로 위에 스크립트를 추가합니다:

```typescript
import Script from "next/script";

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="ko" suppressHydrationWarning>
      <body>
        {children}
        
        {/* 카카오 애드핏 스크립트 (공식 문서: </body> 바로 위에 설치, async 속성 필수) */}
        {/* Next.js에서는 일반 script 태그가 제대로 작동하지 않을 수 있으므로 Script 컴포넌트 사용 */}
        <Script
          src="https://t1.daumcdn.net/kas/static/ba.min.js"
          strategy="afterInteractive"  // ⚡ 중요: lazyOnload가 아닌 afterInteractive 사용
          type="text/javascript"
          charSet="utf-8"
        />
      </body>
    </html>
  );
}
```

**공식 문서 준수 사항**:
- ✅ 스크립트를 `</body>` 바로 위에 설치
- ✅ `async` 속성 포함 (Next.js Script 컴포넌트의 `strategy="afterInteractive"` 사용)
- ✅ `type="text/javascript"` 속성 포함
- ✅ `charset="utf-8"` 속성 포함
- ✅ **`strategy="afterInteractive"` 사용** (빠른 로딩)

#### 2) AdFit 컴포넌트 사용

`src/components/AdFit.tsx` 파일에 이미 구현되어 있으며, 공식 문서를 정확히 준수합니다.

**공식 문서 준수 사항**:
- ✅ `<ins class="kakao_ad_area" style="display:none;width:100%;"` 형식 정확히 준수
- ✅ `data-ad-unit`, `data-ad-width`, `data-ad-height` 속성 사용
- ✅ `layout.tsx`에서 스크립트를 `</body>` 바로 위에 설치 (공식 문서 권장)
- ✅ 스크립트를 `strategy="afterInteractive"`로 설정 (빠른 로딩)
- ✅ NO-AD 콜백 함수 지원 (`onFail` prop)
- ✅ 단순하고 안정적인 구현 (불필요한 로직 제거)
- ✅ AdFit 스크립트가 자동으로 `<ins>` 태그를 스캔하여 광고 표시

**컴포넌트 Props:**
- `unitId` (필수): 카카오 애드핏 광고 단위 ID
- `width` (선택): 광고 너비 (기본값: 320)
- `height` (선택): 광고 높이 (기본값: 100)
- `className` (선택): 추가 CSS 클래스
- `onFail` (선택): NO-AD 콜백 함수 (광고 요청 실패 시 실행)

#### 3) 페이지에 광고 추가

```typescript
import AdFit from "@/components/AdFit";

export default function Page() {
  return (
    <main>
      <h1>페이지 제목</h1>
      
      {/* 카카오 애드핏 광고 */}
      <div className="mb-8 flex justify-center">
        <AdFit
          unitId="DAN-3zxEkFXjkDNH2T9G"  // 실제 광고 단위 ID로 교체
          width={300}
          height={250}
          className="w-full max-w-[300px]"
        />
      </div>
      
      {/* 페이지 콘텐츠 */}
      <article>
        ...
      </article>
    </main>
  );
}
```

---

## ✅ 공식 문서 준수 사항

### 1. 광고 스크립트 설치 위치

**공식 문서 권장사항**:
> 광고 스크립트는 `</body>` 태그 바로 위에 설치하고, `async` 속성을 반드시 포함해야 합니다.

```html
<script async src="https://t1.daumcdn.net/kas/static/ba.min.js"></script>
</body>
```

**Next.js에서의 구현**:
```typescript
<Script
  src="https://t1.daumcdn.net/kas/static/ba.min.js"
  strategy="afterInteractive"  // async 속성과 동일한 효과
  type="text/javascript"
  charSet="utf-8"
/>
</body>
```

### 2. 광고 영역 마크업

**공식 문서 권장사항**:
```html
<ins class="kakao_ad_area" style="display:none;width:100%;"
  data-ad-unit="DAN-XXXXXXXXXXXX"
  data-ad-width="300"
  data-ad-height="250">
</ins>
```

**AdFit 컴포넌트 구현**:
```typescript
<ins
  className="kakao_ad_area"
  style={{ display: "none", width: "100%" }}
  data-ad-unit={unitId}
  data-ad-width={width}
  data-ad-height={height}
  data-ad-onfailure={callbackName}
/>
```

### 3. NO-AD 콜백 함수

**공식 문서 권장사항**:
> 광고 요청 실패 시 콜백 함수를 설정할 수 있습니다. 콜백 함수는 전역 스코프에 등록되어야 합니다.

```html
<ins class="kakao_ad_area" ... data-ad-onfailure="myCallback"></ins>

<script>
  function myCallback(element) {
    console.log('광고 요청 실패:', element);
  }
</script>
```

**AdFit 컴포넌트 구현**:
```typescript
<AdFit
  unitId="DAN-XXXXXXXXXXXX"
  onFail={(element) => {
    console.log('광고 요청 실패:', element);
  }}
/>
```

### 4. 광고 스크립트 자동 스캔

**공식 문서 권장사항**:
> AdFit 스크립트는 페이지 로드 시 자동으로 `<ins class="kakao_ad_area">` 태그를 스캔하여 광고를 표시합니다. 별도의 초기화 코드는 필요하지 않습니다.

**중요**:
- ❌ `adfit.init()` 수동 호출 불필요
- ❌ 복잡한 재시도 로직 불필요
- ❌ `<ins>` 태그 재추가 불필요
- ✅ 단순히 `<ins>` 태그를 올바르게 렌더링하면 됨

---

## 🔧 트러블슈팅

### 1. 광고가 표시되지 않음

**증상**:
- 광고 영역이 비어있거나 표시되지 않음
- 콘솔에 `[AdFit] 스크립트 대기 중, 재시도...` 메시지가 계속 출력됨

**원인**:
- 스크립트 로딩 전략이 `lazyOnload`로 설정되어 너무 늦게 로드됨
- `<ins>` 태그가 올바르게 렌더링되지 않음

**해결 방법**:
1. `layout.tsx`에서 스크립트 전략을 `afterInteractive`로 변경:
   ```typescript
   strategy="afterInteractive"  // ✅
   ```

2. `<ins>` 태그가 올바르게 렌더링되는지 확인:
   - 브라우저 개발자 도구에서 `<ins class="kakao_ad_area">`가 보이는지 확인
   - `data-ad-unit`, `data-ad-width`, `data-ad-height` 속성이 올바른지 확인

### 2. 본문 콘텐츠가 표시되지 않음

**증상**:
- 페이지 헤더와 푸터만 표시되고 본문이 비어있음
- 광고도 함께 표시되지 않음

**원인**:
- `SmoothScroll` 컴포넌트로 인한 Hydration Mismatch
- `MarkdownImage` 컴포넌트의 복잡한 로직으로 인한 렌더링 중단

**해결 방법**:
1. `SmoothScroll` 컴포넌트 제거:
   ```typescript
   // ❌ 변경 전
   return (
     <SmoothScroll>
       <div>...</div>
     </SmoothScroll>
   );
   
   // ✅ 변경 후
   return (
     <div>...</div>
   );
   ```

2. `MarkdownImage` 컴포넌트 단순화:
   - 복잡한 상태 관리 로직을 단순 img 태그로 대체
   - `return null` 대신 항상 무언가를 렌더링

3. ReactMarkdown img 컴포넌트 직접 처리:
   ```typescript
   img: ({ src, alt, ...props }) => {
     if (!src) return null;
     
     const isExternalImage = src.startsWith('http://') || src.startsWith('https://');
     const proxySrc = isExternalImage ? `/api/proxy-image?url=${encodeURIComponent(src)}` : src;
     
     return (
       <div className="my-8">
         <img src={proxySrc} alt={alt || "이미지"} loading="lazy" {...props} />
       </div>
     );
   }
   ```

### 3. Hydration Mismatch 에러

**증상**:
- 콘솔에 `Hydration failed because the server rendered HTML didn't match the client` 에러 출력
- 페이지가 제대로 렌더링되지 않음

**원인**:
- 서버와 클라이언트의 HTML이 일치하지 않음
- 클라이언트 전용 컴포넌트가 서버 사이드 렌더링됨

**해결 방법**:
1. `SmoothScroll` 같은 클라이언트 전용 컴포넌트 제거
2. `isMounted` 상태를 사용하는 로직 제거
3. 서버와 클라이언트에서 동일한 HTML 렌더링되도록 보장

### 4. 이미지 로딩 실패

**증상**:
- 본문의 이미지가 표시되지 않음
- 콘솔에 `[MarkdownImage] ⚠️ imageSrc 또는 proxySrc가 없어 렌더링하지 않습니다` 경고

**원인**:
- `MarkdownImage` 컴포넌트의 복잡한 로직으로 인한 문제
- useEffect 의존성 배열 오류

**해결 방법**:
1. `MarkdownImage` 컴포넌트를 단순 img 태그로 대체
2. ReactMarkdown의 img 컴포넌트에서 직접 처리:
   ```typescript
   img: ({ src, alt }) => {
     if (!src) return null;
     const proxySrc = `/api/proxy-image?url=${encodeURIComponent(src)}`;
     return <img src={proxySrc} alt={alt} />;
   }
   ```

---

## 🔄 업데이트 이력

- **2026-01-21**: 종합적인 개선 및 문제 해결
  - 스크립트 로딩 전략을 `lazyOnload`에서 `afterInteractive`로 변경 (빠른 로딩)
  - AdFit 컴포넌트 대폭 단순화 (공식 문서 권장 방식 준수)
  - 불필요한 재시도 로직 제거 (AdFit 스크립트가 자동으로 처리)
  - 프로덕션 환경의 디버그 로그 제거 (깨끗한 콘솔)
  - 광고 로딩 실패 문제 해결
  - `SmoothScroll` 컴포넌트 제거 (Hydration Mismatch 해결)
  - `MarkdownImage` 컴포넌트 단순화 (렌더링 중단 문제 해결)
  - ReactMarkdown img 컴포넌트 직접 처리 (안정적인 이미지 로딩)
  - 본문 렌더링 문제 완전 해결
  - 광고와 본문이 모두 정상적으로 표시됨
- **2026-01-XX**: AdFit Web SDK 공식 문서 반영
  - [AdFit Web SDK 공식 GitHub 문서](https://github.com/adfit/adfit-web-sdk) 내용 반영
  - 공식 문서 준수 사항 명시
  - 광고 스크립트 수정 금지 경고 추가
  - 스크립트 설치 위치 명확화 (`</body>` 바로 위)
  - NO-AD 콜백 함수 명명 규칙 설명 추가
  - 외부 광고 스크립트 연동 시 주의사항 추가
  - 운영 정책 준수 안내 추가
- **2026-01-XX**: AdFit Web SDK 가이드 반영
  - NO-AD 콜백 함수 지원 추가
  - `charset="utf-8"` 속성 추가
  - 실제 광고 단위 ID 적용 (`DAN-gzhM4ZoHUUTxO6Kg`)
  - 로깅 기능 추가
  - 외부 광고 스크립트 연동 예시 추가
- **2026-01-XX**: 초기 문서 작성
  - 푸터 소유주 정보 추가
  - SEO 최적화 강화
  - 구조화된 데이터 추가

---

**작성자**: 박용범 (decidepyb@gmail.com)  
**최종 업데이트**: 2026-01-21
